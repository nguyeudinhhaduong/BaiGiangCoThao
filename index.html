<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=5.0, user-scalable=yes"
    />
    <title>Toán Học Trực Quan - Cô Thảo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Nunito", "Segoe UI", Arial, sans-serif;
        background: #0a0a1a;
        color: #e0e0e0;
        min-height: 100vh;
      }

      /* ============ LANDING PAGE ============ */
      #landing-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          #0a0a1a 0%,
          #1a1a3e 50%,
          #0a0a1a 100%
        );
        padding: 20px;
      }
      #landing-page .hero-title {
        font-size: 42px;
        font-weight: 800;
        text-align: center;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #4fc3f7, #ab47bc, #ff7043);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      #landing-page .hero-sub {
        font-size: 18px;
        color: #aaa;
        text-align: center;
        margin-bottom: 40px;
      }
      .lesson-cards {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 900px;
      }
      .lesson-card {
        background: linear-gradient(145deg, #16213e, #1a2744);
        border: 2px solid #0f3460;
        border-radius: 16px;
        padding: 30px 28px;
        width: 380px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .lesson-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        border-radius: 16px 16px 0 0;
      }
      .lesson-card:nth-child(1)::before {
        background: linear-gradient(90deg, #4fc3f7, #29b6f6);
      }
      .lesson-card:nth-child(2)::before {
        background: linear-gradient(90deg, #ab47bc, #e040fb);
      }
      .lesson-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 40px rgba(79, 195, 247, 0.15);
        border-color: #4fc3f7;
      }
      .lesson-card .card-icon {
        font-size: 48px;
        margin-bottom: 14px;
      }
      .lesson-card .card-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #fff;
      }
      .lesson-card .card-desc {
        font-size: 14px;
        color: #aab;
        line-height: 1.6;
      }
      .lesson-card .card-tag {
        display: inline-block;
        margin-top: 14px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }
      .lesson-card:nth-child(1) .card-tag {
        background: rgba(79, 195, 247, 0.15);
        color: #4fc3f7;
      }
      .lesson-card:nth-child(2) .card-tag {
        background: rgba(171, 71, 188, 0.15);
        color: #ce93d8;
      }

      .back-btn {
        position: fixed;
        top: 12px;
        left: 12px;
        z-index: 1000;
        padding: 8px 16px;
        background: rgba(15, 52, 96, 0.9);
        border: 1px solid #4fc3f7;
        color: #4fc3f7;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        backdrop-filter: blur(8px);
        transition: all 0.2s;
        display: none;
      }
      .back-btn:hover {
        background: #4fc3f7;
        color: #0a0a1a;
      }

      .lesson-page {
        display: none;
      }
      .lesson-page.active {
        display: block;
      }

      /* ============ LESSON 1 ============ */
      #lesson1 {
        height: 100vh;
        overflow: hidden;
      }
      #lesson1 .container {
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 300px;
        min-width: 300px;
        padding: 12px;
        background: #16213e;
        overflow-y: auto;
        border-right: 2px solid #0f3460;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .sidebar h2 {
        text-align: center;
        color: #4fc3f7;
        font-size: 17px;
        margin-bottom: 4px;
      }
      .main-view {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .top-area {
        flex: 1;
        display: flex;
      }
      #container3d {
        flex: 1;
        position: relative;
        background: #f0f0f0;
        min-height: 0;
      }
      .graph-panel {
        width: 380px;
        min-width: 320px;
        background: #16213e;
        border-left: 2px solid #0f3460;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px;
      }
      .graph-panel h3 {
        color: #4fc3f7;
        font-size: 14px;
        margin-bottom: 4px;
      }
      #graph2d {
        background: #fff;
        border-radius: 6px;
        width: 100%;
        flex: 1;
      }
      .slider-group {
        margin: 2px 0;
      }
      .slider-group label {
        display: flex;
        align-items: center;
        font-size: 13px;
        gap: 6px;
      }
      .slider-group input[type="range"] {
        flex: 1;
        height: 6px;
        cursor: pointer;
        accent-color: #4fc3f7;
      }
      .val {
        font-weight: bold;
        color: #4fc3f7;
        min-width: 40px;
        text-align: right;
      }
      .info-box {
        background: #0f3460;
        padding: 10px;
        border-radius: 8px;
        margin: 4px 0;
      }
      .info-box p {
        margin: 3px 0;
        font-size: 13px;
        line-height: 1.5;
      }
      .info-box b {
        color: #4fc3f7;
      }
      .formula {
        text-align: center;
        font-size: 16px;
        color: #e8e8e8;
        margin: 6px 0;
        background: #0f3460;
        padding: 8px;
        border-radius: 6px;
      }
      .note {
        background: #fff9c4;
        color: #333;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.5;
      }
      .func-input {
        display: flex;
        gap: 6px;
        align-items: center;
        margin: 2px 0;
      }
      .func-input label {
        font-size: 13px;
        white-space: nowrap;
      }
      .func-input input {
        flex: 1;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #4fc3f7;
        background: #0a1628;
        color: #4fc3f7;
        font-size: 13px;
        font-family: monospace;
      }
      .btn-row {
        display: flex;
        gap: 6px;
        margin: 4px 0;
        flex-wrap: wrap;
      }
      .btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        color: #fff;
        background: #0f3460;
        transition: background 0.2s;
      }
      .btn:hover {
        background: #1a5276;
      }
      .btn.active {
        background: #e74c3c;
      }
      .help {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        line-height: 1.6;
      }
      .disk-info {
        background: #1b3a5c;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        margin: 2px 0;
        border-left: 3px solid #ffdd00;
      }
      .disk-info span {
        color: #ffdd00;
        font-weight: bold;
      }

      /* ============ LESSON 2 ============ */
      #lesson2 {
        height: 100vh;
        overflow: hidden;
      }
      #lesson2 .l2-container {
        display: flex;
        height: 100vh;
      }
      #lesson2 .l2-sidebar {
        width: 320px;
        min-width: 320px;
        padding: 14px;
        background: #16213e;
        overflow-y: auto;
        border-right: 2px solid #0f3460;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      #lesson2 .l2-sidebar h2 {
        text-align: center;
        color: #ce93d8;
        font-size: 17px;
        margin-bottom: 4px;
      }
      #lesson2 .l2-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        position: relative;
      }
      #lesson2 canvas {
        width: 100%;
        height: 100%;
      }
      #lesson2 .l2-func-input {
        display: flex;
        gap: 6px;
        align-items: center;
        margin: 2px 0;
      }
      #lesson2 .l2-func-input label {
        font-size: 13px;
        white-space: nowrap;
        color: #ce93d8;
        font-weight: 700;
      }
      #lesson2 .l2-func-input input {
        flex: 1;
        padding: 5px 8px;
        border-radius: 4px;
        border: 1px solid #ce93d8;
        background: #0a1628;
        color: #ce93d8;
        font-size: 13px;
        font-family: monospace;
      }
      #lesson2 .l2-slider {
        margin: 3px 0;
      }
      #lesson2 .l2-slider label {
        display: flex;
        align-items: center;
        font-size: 13px;
        gap: 6px;
      }
      #lesson2 .l2-slider input[type="range"] {
        flex: 1;
        height: 6px;
        cursor: pointer;
        accent-color: #ce93d8;
      }
      #lesson2 .l2-val {
        font-weight: bold;
        color: #ce93d8;
        min-width: 40px;
        text-align: right;
      }
      #lesson2 .l2-info {
        background: #0f3460;
        padding: 10px;
        border-radius: 8px;
        margin: 4px 0;
      }
      #lesson2 .l2-info p {
        margin: 3px 0;
        font-size: 13px;
        line-height: 1.5;
      }
      #lesson2 .l2-info b {
        color: #ce93d8;
      }
      #lesson2 .l2-formula {
        text-align: center;
        font-size: 15px;
        color: #e8e8e8;
        margin: 6px 0;
        background: #0f3460;
        padding: 8px;
        border-radius: 6px;
      }
      #lesson2 .l2-note {
        background: #f3e5f5;
        color: #333;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.5;
      }
      #lesson2 .l2-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        color: #fff;
        background: #6a1b9a;
        transition: background 0.2s;
      }
      #lesson2 .l2-btn:hover {
        background: #8e24aa;
      }
      #lesson2 .l2-btn.active {
        background: #e74c3c;
      }
      #lesson2 .l2-rect-list {
        background: #0a1628;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 8px;
        max-height: 100px;
        overflow-y: auto;
        font-size: 11px;
        font-family: monospace;
        color: #ce93d8;
        line-height: 1.5;
      }
      .l2-help {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        line-height: 1.6;
      }

      /* ===== TABLET ===== */
      @media (max-width: 900px) {
        body {
          overflow: auto;
          font-size: 15px;
        }
        #lesson1,
        #lesson2 {
          height: auto;
          overflow: auto;
        }
        #lesson1 .container,
        #lesson2 .l2-container {
          flex-direction: column;
          height: auto;
          min-height: 100vh;
        }
        .sidebar,
        #lesson2 .l2-sidebar {
          width: 100%;
          min-width: unset;
          border-right: none;
          border-bottom: 2px solid #0f3460;
        }
        .top-area {
          flex-direction: column;
        }
        #container3d {
          width: 100%;
          height: 50vh;
          min-height: 280px;
        }
        .graph-panel {
          width: 100%;
          min-width: unset;
          height: 320px;
          border-left: none;
          border-top: 2px solid #0f3460;
        }
        #lesson2 .l2-main {
          min-height: 60vh;
        }
        .lesson-cards {
          flex-direction: column;
          align-items: center;
        }
        .lesson-card {
          width: 100%;
          max-width: 400px;
        }
        #landing-page .hero-title {
          font-size: 28px;
        }
      }

      /* ===== PHONE ===== */
      @media (max-width: 480px) {
        body {
          font-size: 16px;
          -webkit-text-size-adjust: 100%;
        }

        /* Landing page */
        #landing-page {
          padding: 16px 10px;
        }
        #landing-page .hero-title {
          font-size: 24px;
        }
        #landing-page .hero-sub {
          font-size: 15px;
          margin-bottom: 24px;
        }
        .lesson-card {
          padding: 20px 18px;
        }
        .lesson-card .card-icon {
          font-size: 36px;
          margin-bottom: 10px;
        }
        .lesson-card .card-title {
          font-size: 17px;
        }
        .lesson-card .card-desc {
          font-size: 13px;
        }

        /* Back button */
        .back-btn {
          padding: 10px 18px;
          font-size: 15px;
          top: 8px;
          left: 8px;
        }

        /* Sidebars */
        .sidebar,
        #lesson2 .l2-sidebar {
          padding: 10px;
          gap: 8px;
        }
        .sidebar h2,
        #lesson2 .l2-sidebar h2 {
          font-size: 18px;
          margin-bottom: 6px;
        }

        /* Function inputs */
        .func-input input,
        #lesson2 .l2-func-input input {
          font-size: 15px;
          padding: 8px 10px;
          min-height: 40px;
        }
        .func-input label,
        #lesson2 .l2-func-input label {
          font-size: 15px;
        }

        /* Sliders - bigger touch target */
        .slider-group label,
        #lesson2 .l2-slider label {
          font-size: 14px;
          gap: 8px;
          min-height: 36px;
        }
        .slider-group input[type="range"],
        #lesson2 .l2-slider input[type="range"] {
          height: 10px;
          min-height: 36px;
        }
        .val,
        #lesson2 .l2-val {
          font-size: 15px;
          min-width: 48px;
        }

        /* Buttons - bigger touch target */
        .btn,
        #lesson2 .l2-btn {
          padding: 10px 14px;
          font-size: 14px;
          min-height: 40px;
          border-radius: 6px;
        }
        .btn-row {
          gap: 8px;
          margin: 6px 0;
        }

        /* Info boxes */
        .info-box,
        #lesson2 .l2-info {
          padding: 12px;
        }
        .info-box p,
        #lesson2 .l2-info p {
          font-size: 14px;
          margin: 4px 0;
        }
        .formula,
        #lesson2 .l2-formula {
          font-size: 16px;
          padding: 10px;
        }

        /* Disk info */
        .disk-info {
          font-size: 13px;
          padding: 8px 12px;
        }

        /* Note */
        .note,
        #lesson2 .l2-note {
          font-size: 13px;
          padding: 10px;
        }

        /* 3D & graph */
        #container3d {
          height: 45vh;
          min-height: 240px;
        }
        .graph-panel {
          height: 280px;
          padding: 10px;
        }
        .graph-panel h3 {
          font-size: 15px;
        }

        /* L2 canvas */
        #lesson2 .l2-main {
          min-height: 55vh;
        }

        /* Rect list */
        #lesson2 .l2-rect-list {
          font-size: 12px;
          padding: 10px;
          max-height: 80px;
        }

        /* Help text hidden on phone */
        .help,
        .l2-help {
          display: none;
        }
      }

      /* ===== VERY SMALL PHONE ===== */
      @media (max-width: 360px) {
        #landing-page .hero-title {
          font-size: 20px;
        }
        .sidebar,
        #lesson2 .l2-sidebar {
          padding: 8px;
        }
        .func-input input,
        #lesson2 .l2-func-input input {
          font-size: 14px;
          padding: 6px 8px;
          min-height: 36px;
        }
        .btn,
        #lesson2 .l2-btn {
          padding: 8px 10px;
          font-size: 13px;
          min-height: 36px;
        }
        #container3d {
          height: 40vh;
          min-height: 200px;
        }
        .graph-panel {
          height: 240px;
        }
      }
    </style>
  </head>
  <body>
    <!-- ================== LANDING PAGE ================== -->
    <div id="landing-page">
      <div class="hero-title">&#x1F4D0; Toán Học Trực Quan</div>
      <div class="hero-sub">Chọn bài học để bắt đầu</div>
      <div class="lesson-cards">
        <div class="lesson-card" onclick="openLesson(1)">
          <div class="card-icon">&#x1F504;</div>
          <div class="card-title">Bài 1: Thể Tích Vật Thể Tròn Xoay</div>
          <div class="card-desc">
            Khám phá phương pháp đĩa để tính thể tích vật thể tròn xoay. Trực
            quan hóa 3D với các lát cắt hình trụ, điều chỉnh hàm số và tham số
            để hiểu sâu hơn.
          </div>
          <span class="card-tag">Giải tích &#x2022; 3D</span>
        </div>
        <div class="lesson-card" onclick="openLesson(2)">
          <div class="card-icon">&#x1F4CA;</div>
          <div class="card-title">
            Bài 2: Tích Phân Xác Định &amp; Tổng Riemann
          </div>
          <div class="card-desc">
            Trực quan hóa tích phân xác định bằng tổng Riemann. Nhập bất kỳ hàm
            số nào, điều chỉnh cận và số hình chữ nhật để thấy quá trình hội tụ.
          </div>
          <span class="card-tag">Giải tích &#x2022; 2D</span>
        </div>
      </div>
    </div>

    <button class="back-btn" id="back-btn" onclick="goHome()">
      &#x2190; Quay lại
    </button>

    <!-- ================== LESSON 1 ================== -->
    <div id="lesson1" class="lesson-page">
      <div class="container">
        <div class="sidebar">
          <h2>&#x1F504; Thể Tích Tròn Xoay</h2>
          <div class="func-input">
            <label>f(x) =</label>
            <input
              type="text"
              id="func-input"
              value="sqrt(x)"
              spellcheck="false"
            />
            <button class="btn" onclick="applyFunction()">OK</button>
          </div>
          <div class="slider-group">
            <label
              >a = <span class="val" id="val-a">0</span
              ><input
                type="range"
                id="slider-a"
                min="-5"
                max="10"
                step="0.1"
                value="0"
            /></label>
          </div>
          <div class="slider-group">
            <label
              >b = <span class="val" id="val-b">4</span
              ><input
                type="range"
                id="slider-b"
                min="-5"
                max="16"
                step="0.1"
                value="4"
            /></label>
          </div>
          <div class="slider-group">
            <label
              >&#x03B1; = <span class="val" id="val-alpha">360&#xB0;</span
              ><input
                type="range"
                id="slider-alpha"
                min="0"
                max="360"
                step="1"
                value="360"
            /></label>
          </div>
          <div class="slider-group">
            <label
              >n = <span class="val" id="val-n">20</span
              ><input
                type="range"
                id="slider-n"
                min="1"
                max="100"
                step="1"
                value="20"
            /></label>
          </div>
          <div class="slider-group">
            <label
              >k = <span class="val" id="val-k">1</span
              ><input
                type="range"
                id="slider-k"
                min="1"
                max="20"
                step="1"
                value="1"
            /></label>
          </div>
          <div class="btn-row">
            <button class="btn" id="btn-play-alpha" onclick="togglePlayAlpha()">
              &#x25B6; Quay &#x03B1;
            </button>
            <button class="btn" id="btn-play-n" onclick="togglePlayN()">
              &#x25B6; Tăng n
            </button>
            <button class="btn" onclick="resetView()">&#x21BA; Reset</button>
          </div>
          <div class="info-box">
            <p>
              <b>Thể tích vật thể (V)</b> =
              <span id="exact-vol" style="color: #4fc3f7">0</span>
            </p>
            <p>
              <b>Tổng thể tích n trụ (S&#x2099;)</b> =
              <span id="approx-vol" style="color: #ffd54f">0</span>
            </p>
            <p>
              <b>Sai số |V - S&#x2099;|</b> =
              <span id="error-vol" style="color: #ef5350">0</span>
            </p>
          </div>
          <div class="disk-info" id="disk-info">
            Lát cắt <span>k=1</span>: x = 0, r = 0, &#x0394;V = 0
          </div>
          <div class="formula">
            V = &#x222B;<sub>a</sub><sup>b</sup> &#x03C0; [f(x)]&#xB2; dx
          </div>
          <div class="note">
            &#x1F4CC; Khi <b>n càng lớn</b> thì tổng S&#x2099;
            <b>càng gần</b> với thể tích vật thể V.<br />S&#x2099; &#x2192; V
            khi n &#x2192; &#x221E;
          </div>
          <div class="help">
            &#x1F5B1; Chuột trái: Xoay | Chuột phải: Di chuyển<br />&#x1F504;
            Cuộn: Phóng to/nhỏ | Shift+Kéo: Dịch vật thể<br />&#x1F4DD; Hàm:
            sqrt(x), x^2, sin(x), abs(x), exp(x), x^3-2x+1...
          </div>
        </div>
        <div class="main-view">
          <div class="top-area">
            <div id="container3d"></div>
            <div class="graph-panel">
              <h3>Đồ thị y = f(x)</h3>
              <canvas id="graph2d"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================== LESSON 2 ================== -->
    <div id="lesson2" class="lesson-page">
      <div class="l2-container">
        <div class="l2-sidebar">
          <h2>&#x1F4CA; Tích Phân &amp; Tổng Riemann</h2>
          <div class="l2-func-input">
            <label>f(x) =</label>
            <input
              type="text"
              id="l2-func-input"
              value="x^2 - 2x + 3"
              spellcheck="false"
            />
            <button class="l2-btn" onclick="L2.applyFunction()">OK</button>
          </div>
          <div class="l2-slider">
            <label
              >a = <span class="l2-val" id="l2-val-a">-1</span
              ><input
                type="range"
                id="l2-slider-a"
                min="-10"
                max="10"
                step="0.1"
                value="-1"
            /></label>
          </div>
          <div class="l2-slider">
            <label
              >b = <span class="l2-val" id="l2-val-b">9</span
              ><input
                type="range"
                id="l2-slider-b"
                min="-10"
                max="10"
                step="0.1"
                value="9"
            /></label>
          </div>
          <div class="l2-slider">
            <label
              >n = <span class="l2-val" id="l2-val-n">50</span
              ><input
                type="range"
                id="l2-slider-n"
                min="1"
                max="200"
                step="1"
                value="50"
            /></label>
          </div>
          <div class="btn-row">
            <button
              class="l2-btn"
              id="l2-btn-left"
              onclick="L2.setMethod('left')"
              style="background: #6a1b9a"
            >
              &#x25C0; Trái
            </button>
            <button
              class="l2-btn"
              id="l2-btn-right"
              onclick="L2.setMethod('right')"
            >
              Phải &#x25B6;
            </button>
            <button
              class="l2-btn"
              id="l2-btn-mid"
              onclick="L2.setMethod('mid')"
            >
              &#x25AE; Giữa
            </button>
            <button
              class="l2-btn"
              id="l2-btn-trap"
              onclick="L2.setMethod('trap')"
            >
              &#x23E2; Hình thang
            </button>
          </div>
          <div class="btn-row">
            <button class="l2-btn" id="l2-btn-play" onclick="L2.togglePlay()">
              &#x25B6; Tăng n
            </button>
            <button class="l2-btn" onclick="L2.resetView()">
              &#x21BA; Reset
            </button>
          </div>
          <div class="l2-info">
            <p>
              <b>Tích phân chính xác (I)</b> =
              <span id="l2-exact" style="color: #ce93d8">0</span>
            </p>
            <p>
              <b>Tổng Riemann (S&#x2099;)</b> =
              <span id="l2-approx" style="color: #ffd54f">0</span>
            </p>
            <p>
              <b>Sai số |I - S&#x2099;|</b> =
              <span id="l2-error" style="color: #ef5350">0</span>
            </p>
          </div>
          <div class="l2-formula">
            I = &#x222B;<sub>a</sub><sup>b</sup> f(x) dx
          </div>
          <div style="font-size: 12px; color: #aaa; margin: 2px 0">
            Diện tích các hình chữ nhật:
          </div>
          <div class="l2-rect-list" id="l2-rect-list"></div>
          <div class="l2-note">
            &#x1F4CC; Khi <b>n &#x2192; &#x221E;</b>, tổng Riemann S&#x2099;
            <b>hội tụ</b> về tích phân I.<br />Phương pháp: Trái, Phải, Giữa,
            Hình thang.
          </div>
          <div class="l2-help">
            &#x1F4DD; Hàm: x^2, x^3, sin(x), cos(x), tan(x), sqrt(x), abs(x),
            exp(x), ln(x), log(x), asin(x), acos(x), atan(x), sinh(x), cosh(x),
            tanh(x), floor(x), ceil(x), sign(x), cbrt(x), sec(x), csc(x),
            cot(x), pi, e...<br />&#x1F4DD; Đa thức: 3x^4-2x^3+x^2-5x+7<br />&#x1F4DD;
            Nhân ẩn: 2x, 3sin(x), 2(x+1)...
          </div>
        </div>
        <div class="l2-main">
          <canvas id="l2-canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- ================== SCRIPTS ================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
      /* =====================================================================
       UNIVERSAL MATH PARSER - supports all functions + polynomials
       ===================================================================== */
      function parseMathExpr(expr) {
        var s = expr.trim();
        s = s.replace(/\s+/g, " ");

        // Replace constants
        s = s.replace(/\bpi\b/gi, "(Math.PI)");
        // Replace 'e' only when standalone (not part of exp, ceil, etc)
        s = s.replace(/(?<![a-zA-Z])e(?![a-zA-Z])/g, "(Math.E)");

        // Replace math functions (longer names first to avoid partial matches)
        var funcs = [
          ["arcsinh", "Math.asinh"],
          ["arccosh", "Math.acosh"],
          ["arctanh", "Math.atanh"],
          ["arcsin", "Math.asin"],
          ["arccos", "Math.acos"],
          ["arctan", "Math.atan"],
          ["asinh", "Math.asinh"],
          ["acosh", "Math.acosh"],
          ["atanh", "Math.atanh"],
          ["asin", "Math.asin"],
          ["acos", "Math.acos"],
          ["atan2", "Math.atan2"],
          ["atan", "Math.atan"],
          ["sinh", "Math.sinh"],
          ["cosh", "Math.cosh"],
          ["tanh", "Math.tanh"],
          ["sqrt", "Math.sqrt"],
          ["cbrt", "Math.cbrt"],
          ["sin", "Math.sin"],
          ["cos", "Math.cos"],
          ["tan", "Math.tan"],
          ["log10", "Math.log10"],
          ["log2", "Math.log2"],
          ["log", "Math.log"],
          ["ln", "Math.log"],
          ["exp", "Math.exp"],
          ["abs", "Math.abs"],
          ["sign", "Math.sign"],
          ["floor", "Math.floor"],
          ["ceil", "Math.ceil"],
          ["round", "Math.round"],
          ["max", "Math.max"],
          ["min", "Math.min"],
          ["pow", "Math.pow"],
          ["trunc", "Math.trunc"],
          ["hypot", "Math.hypot"],
          ["sec", "__sec__"],
          ["csc", "__csc__"],
          ["cot", "__cot__"],
        ];

        for (var i = 0; i < funcs.length; i++) {
          var name = funcs[i][0],
            repl = funcs[i][1];
          var re = new RegExp("\\b" + name + "\\s*\\(", "gi");
          s = s.replace(re, repl + "(");
        }

        // Power operator
        s = s.replace(/\^/g, "**");

        // Implicit multiplication
        // digit before letter (but not part of Math. or __sec__ etc)
        s = s.replace(/(\d)([a-zA-Z_])/g, function (m, d, l) {
          // Check if this is the start of Math. or __
          if (l === "M" || l === "_") {
            // Look ahead to check
            return d + "*" + l;
          }
          return d + "*" + l;
        });
        // ) before ( or letter/digit
        s = s.replace(/\)\s*\(/g, ")*(");
        s = s.replace(/\)\s*([a-zA-Z0-9_])/g, ")*$1");
        // digit or ) before (
        s = s.replace(/(\d)\s*\(/g, "$1*(");
        // variable before (
        s = s.replace(/\bx\s*\(/g, "x*(");

        return s;
      }

      function createSafeFunction(expr) {
        var processed = parseMathExpr(expr);
        var body =
          "try {" +
          "var __sec__ = function(v) { return 1/Math.cos(v); };" +
          "var __csc__ = function(v) { return 1/Math.sin(v); };" +
          "var __cot__ = function(v) { return Math.cos(v)/Math.sin(v); };" +
          "var r = " +
          processed +
          ";" +
          'return (typeof r === "number" && isFinite(r)) ? r : NaN;' +
          "} catch(e) { return NaN; }";
        var fn = new Function("x", body);
        // Test the function
        fn(0);
        fn(1);
        fn(-1);
        fn(0.5);
        fn(2);
        return fn;
      }

      /* =====================================================================
       NAVIGATION
       ===================================================================== */
      var currentLesson = 0;

      function openLesson(num) {
        document.getElementById("landing-page").style.display = "none";
        document.getElementById("back-btn").style.display = "block";
        if (num === 1) {
          document.getElementById("lesson1").classList.add("active");
          document.getElementById("lesson2").classList.remove("active");
          if (!L1.initialized) {
            L1.init();
          } else {
            setTimeout(function () {
              L1.onResize();
            }, 50);
          }
        } else {
          document.getElementById("lesson2").classList.add("active");
          document.getElementById("lesson1").classList.remove("active");
          if (!L2.initialized) {
            L2.init();
          } else {
            setTimeout(function () {
              L2.draw();
            }, 50);
          }
        }
        currentLesson = num;
      }

      function goHome() {
        document.getElementById("landing-page").style.display = "flex";
        document.getElementById("back-btn").style.display = "none";
        document.getElementById("lesson1").classList.remove("active");
        document.getElementById("lesson2").classList.remove("active");
        currentLesson = 0;
      }

      /* =====================================================================
       LESSON 1: VOLUME OF REVOLUTION
       ===================================================================== */
      var L1 = {
        initialized: false,
        scene: null,
        camera: null,
        renderer: null,
        controls: null,
        solidGroup: null,
        diskGroup: null,
        curveGroup: null,
        params: { a: 0, b: 4, alpha: 360, n: 20, k: 1 },
        animAlpha: false,
        animN: false,
        isDragging: false,
        currentFuncStr: "sqrt(x)",
        f: null,

        init: function () {
          var self = this;
          this.f = function (x) {
            return Math.sqrt(Math.max(0, x));
          };
          this.dragPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
          this.raycaster = new THREE.Raycaster();
          this.mouse = new THREE.Vector2();
          this.dragOffset = new THREE.Vector3();

          var container = document.getElementById("container3d");
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0xf5f5f5);
          this.camera = new THREE.PerspectiveCamera(
            50,
            container.clientWidth / container.clientHeight,
            0.01,
            200,
          );
          this.camera.position.set(7, 4, 6);

          this.renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true,
          });
          this.renderer.setSize(container.clientWidth, container.clientHeight);
          this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          container.appendChild(this.renderer.domElement);

          this.controls = new THREE.OrbitControls(
            this.camera,
            this.renderer.domElement,
          );
          this.controls.target.set(2, 0, 0);
          this.controls.enableDamping = true;
          this.controls.dampingFactor = 0.08;
          this.controls.enablePan = true;
          this.controls.update();

          this.scene.add(new THREE.AmbientLight(0xffffff, 0.55));
          var dl = new THREE.DirectionalLight(0xffffff, 0.65);
          dl.position.set(8, 12, 10);
          this.scene.add(dl);
          var dl2 = new THREE.DirectionalLight(0xffffff, 0.25);
          dl2.position.set(-5, -3, -5);
          this.scene.add(dl2);

          this.createAxes();
          this.scene.add(new THREE.GridHelper(20, 20, 0xbbbbbb, 0xdddddd));

          this.solidGroup = new THREE.Group();
          this.diskGroup = new THREE.Group();
          this.curveGroup = new THREE.Group();
          this.scene.add(this.solidGroup);
          this.scene.add(this.diskGroup);
          this.scene.add(this.curveGroup);

          this.setupDrag(container);
          this.setupSliders();
          this.updateAll();

          function animate() {
            requestAnimationFrame(animate);
            self.controls.update();
            self.renderer.render(self.scene, self.camera);
          }
          animate();
          this.initialized = true;
        },

        createAxes: function () {
          this.scene.add(
            new THREE.ArrowHelper(
              new THREE.Vector3(1, 0, 0),
              new THREE.Vector3(-1, 0, 0),
              12,
              0xdd0000,
              0.25,
              0.12,
            ),
          );
          this.scene.add(
            new THREE.ArrowHelper(
              new THREE.Vector3(0, 1, 0),
              new THREE.Vector3(0, -1, 0),
              6,
              0x00aa00,
              0.25,
              0.12,
            ),
          );
          this.scene.add(
            new THREE.ArrowHelper(
              new THREE.Vector3(0, 0, 1),
              new THREE.Vector3(0, 0, -1),
              6,
              0x0044dd,
              0.25,
              0.12,
            ),
          );
          var labels = ["x", "y", "z"];
          var colors = ["#dd0000", "#00aa00", "#0044dd"];
          var positions = [
            new THREE.Vector3(11.5, 0.4, 0),
            new THREE.Vector3(0.4, 5.5, 0),
            new THREE.Vector3(0, 0.4, 5.5),
          ];
          for (var i = 0; i < 3; i++) {
            var canvas = document.createElement("canvas");
            canvas.width = 64;
            canvas.height = 64;
            var ctx = canvas.getContext("2d");
            ctx.font = "bold 48px Arial";
            ctx.fillStyle = colors[i];
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(labels[i], 32, 32);
            var tex = new THREE.CanvasTexture(canvas);
            var sprite = new THREE.Sprite(
              new THREE.SpriteMaterial({ map: tex }),
            );
            sprite.position.copy(positions[i]);
            sprite.scale.set(0.6, 0.6, 1);
            this.scene.add(sprite);
          }
        },

        clearGroup: function (group) {
          while (group.children.length > 0) {
            var c = group.children[0];
            if (c.geometry) c.geometry.dispose();
            if (c.material) {
              if (c.material.map) c.material.map.dispose();
              c.material.dispose();
            }
            group.remove(c);
          }
        },

        buildSolid: function () {
          this.clearGroup(this.solidGroup);
          this.clearGroup(this.curveGroup);
          var a = this.params.a,
            b = this.params.b,
            alpha = this.params.alpha;
          var alphaRad = (alpha * Math.PI) / 180;
          if (b <= a || alphaRad <= 0) return;

          var nU = 80,
            nV = 64;
          var mat = new THREE.MeshPhongMaterial({
            color: 0x9999cc,
            transparent: true,
            opacity: 0.3,
            side: THREE.DoubleSide,
            depthWrite: false,
          });
          var self = this;

          var verts = [],
            idx = [];
          for (var i = 0; i <= nU; i++) {
            var u = a + ((b - a) * i) / nU;
            var r = Math.abs(self.f(u)) || 0;
            for (var j = 0; j <= nV; j++) {
              var th = (alphaRad * j) / nV;
              verts.push(u, r * Math.cos(th), r * Math.sin(th));
            }
          }
          for (var i = 0; i < nU; i++) {
            for (var j = 0; j < nV; j++) {
              var p = i * (nV + 1) + j;
              idx.push(p, p + 1, p + nV + 1);
              idx.push(p + 1, p + nV + 2, p + nV + 1);
            }
          }
          var surfGeo = new THREE.BufferGeometry();
          surfGeo.setAttribute(
            "position",
            new THREE.Float32BufferAttribute(verts, 3),
          );
          surfGeo.setIndex(idx);
          surfGeo.computeVertexNormals();
          this.solidGroup.add(new THREE.Mesh(surfGeo, mat));

          // End caps
          var caps = [a, b];
          for (var ci = 0; ci < caps.length; ci++) {
            var x = caps[ci];
            var r = Math.abs(self.f(x)) || 0;
            if (r < 0.001) continue;
            var cv = [x, 0, 0],
              cIdx = [];
            for (var j = 0; j <= nV; j++) {
              var th = (alphaRad * j) / nV;
              cv.push(x, r * Math.cos(th), r * Math.sin(th));
            }
            for (var j = 0; j < nV; j++) cIdx.push(0, j + 1, j + 2);
            var g = new THREE.BufferGeometry();
            g.setAttribute("position", new THREE.Float32BufferAttribute(cv, 3));
            g.setIndex(cIdx);
            g.computeVertexNormals();
            this.solidGroup.add(new THREE.Mesh(g, mat.clone()));
          }

          // Flat sides
          if (alpha < 359.5) {
            var thetas = [0, alphaRad];
            for (var ti = 0; ti < thetas.length; ti++) {
              var theta = thetas[ti];
              var sv = [],
                si = [];
              for (var i = 0; i <= nU; i++) {
                var u = a + ((b - a) * i) / nU;
                var r = Math.abs(self.f(u)) || 0;
                sv.push(u, 0, 0);
                sv.push(u, r * Math.cos(theta), r * Math.sin(theta));
              }
              for (var i = 0; i < nU; i++) {
                var p = i * 2;
                si.push(p, p + 1, p + 2);
                si.push(p + 1, p + 3, p + 2);
              }
              var g = new THREE.BufferGeometry();
              g.setAttribute(
                "position",
                new THREE.Float32BufferAttribute(sv, 3),
              );
              g.setIndex(si);
              g.computeVertexNormals();
              this.solidGroup.add(new THREE.Mesh(g, mat.clone()));
            }
          }

          // Profile curve
          var curvePoints = [];
          for (var i = 0; i <= nU; i++) {
            var u = a + ((b - a) * i) / nU;
            curvePoints.push(new THREE.Vector3(u, Math.abs(self.f(u)) || 0, 0));
          }
          this.curveGroup.add(
            new THREE.Line(
              new THREE.BufferGeometry().setFromPoints(curvePoints),
              new THREE.LineBasicMaterial({ color: 0xdd0000, linewidth: 2 }),
            ),
          );

          if (alpha >= 180) {
            var bp = [];
            for (var i = 0; i <= nU; i++) {
              var u = a + ((b - a) * i) / nU;
              bp.push(new THREE.Vector3(u, -(Math.abs(self.f(u)) || 0), 0));
            }
            this.curveGroup.add(
              new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(bp),
                new THREE.LineBasicMaterial({ color: 0xdd0000, linewidth: 1 }),
              ),
            );
          }

          // Edge circles
          for (var ci = 0; ci < caps.length; ci++) {
            var x = caps[ci];
            var r = Math.abs(self.f(x)) || 0;
            if (r < 0.001) continue;
            var cp = [];
            for (var j = 0; j <= 64; j++) {
              var th = (alphaRad * j) / 64;
              cp.push(new THREE.Vector3(x, r * Math.cos(th), r * Math.sin(th)));
            }
            this.curveGroup.add(
              new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(cp),
                new THREE.LineBasicMaterial({ color: 0xdd0000 }),
              ),
            );
          }
        },

        buildDisks: function () {
          this.clearGroup(this.diskGroup);
          var a = this.params.a,
            b = this.params.b,
            n = this.params.n,
            k = this.params.k,
            alpha = this.params.alpha;
          var alphaRad = (alpha * Math.PI) / 180;
          if (b <= a || n <= 0 || alphaRad <= 0) return;
          var dx = (b - a) / n;
          var self = this;
          for (var i = 0; i < n; i++) {
            var xi = a + i * dx;
            var radius = Math.abs(self.f(xi)) || 0;
            if (radius < 0.0005) continue;
            var isK = i === k - 1;
            var geo = new THREE.CylinderGeometry(
              radius,
              radius,
              dx,
              32,
              1,
              false,
              0,
              alphaRad,
            );
            var mat = new THREE.MeshPhongMaterial({
              color: isK ? 0xffcc00 : 0xff6699,
              transparent: true,
              opacity: isK ? 0.75 : 0.4,
              side: THREE.DoubleSide,
              depthWrite: false,
            });
            var mesh = new THREE.Mesh(geo, mat);
            mesh.rotation.z = -Math.PI / 2;
            mesh.position.x = xi + dx / 2;
            this.diskGroup.add(mesh);
          }
          this.diskGroup.position.copy(this.solidGroup.position);
        },

        updateVolumes: function () {
          var a = this.params.a,
            b = this.params.b,
            n = this.params.n,
            k = this.params.k;
          var self = this;
          if (b <= a) {
            document.getElementById("exact-vol").textContent = "0";
            document.getElementById("approx-vol").textContent = "0";
            document.getElementById("error-vol").textContent = "0";
            return;
          }
          var N = 2000,
            h = (b - a) / N,
            simpson = 0;
          for (var i = 0; i <= N; i++) {
            var x = a + i * h;
            var fv = self.f(x);
            var y = Math.PI * fv * fv;
            simpson +=
              (isFinite(y) ? y : 0) *
              (i === 0 || i === N ? 1 : i % 2 === 1 ? 4 : 2);
          }
          var exactVol = (simpson * h) / 3;
          var dx = (b - a) / n,
            riemannSum = 0;
          for (var i = 0; i < n; i++) {
            var xi = a + i * dx;
            var fv = self.f(xi);
            riemannSum += Math.PI * fv * fv * dx;
          }
          document.getElementById("exact-vol").textContent = isFinite(exactVol)
            ? exactVol.toFixed(4)
            : "N/A";
          document.getElementById("approx-vol").textContent = isFinite(
            riemannSum,
          )
            ? riemannSum.toFixed(4)
            : "N/A";
          document.getElementById("error-vol").textContent =
            isFinite(exactVol) && isFinite(riemannSum)
              ? Math.abs(exactVol - riemannSum).toFixed(4)
              : "N/A";

          var kIdx = Math.min(k, n) - 1;
          var xk = a + kIdx * dx;
          var rk = Math.abs(self.f(xk)) || 0;
          var dvk = Math.PI * rk * rk * dx;
          document.getElementById("disk-info").innerHTML =
            "L\u00e1t c\u1eaft <span>k=" +
            k +
            "</span>: x<sub>" +
            k +
            "</sub> = " +
            xk.toFixed(2) +
            ", r = f(" +
            xk.toFixed(2) +
            ") = " +
            rk.toFixed(3) +
            ", \u0394V<sub>" +
            k +
            "</sub> = " +
            dvk.toFixed(4);
        },

        draw2DGraph: function () {
          var canvas = document.getElementById("graph2d");
          var rect = canvas.parentElement.getBoundingClientRect();
          var dpr = Math.min(window.devicePixelRatio || 1, 2);
          var W = Math.floor(rect.width - 16);
          var H = Math.floor(rect.height - 40);
          if (W <= 0 || H <= 0) return;
          canvas.width = W * dpr;
          canvas.height = H * dpr;
          canvas.style.width = W + "px";
          canvas.style.height = H + "px";
          var ctx = canvas.getContext("2d");
          ctx.scale(dpr, dpr);

          var a = this.params.a,
            b = this.params.b,
            n = this.params.n,
            k = this.params.k;
          var self = this;
          var margin = 35;
          var xMin = Math.min(a - 0.5, -0.5);
          var xMax = Math.max(b + 1.5, 5);
          var yMaxCalc = 0;
          for (var i = 0; i <= 200; i++) {
            var x = xMin + ((xMax - xMin) * i) / 200;
            var fv = self.f(x);
            if (isFinite(fv) && Math.abs(fv) > yMaxCalc)
              yMaxCalc = Math.abs(fv);
          }
          var yMax = Math.max(yMaxCalc * 1.3 + 0.5, 2.5);
          var yMin = -0.3;
          var pW = W - 2 * margin,
            pH = H - 2 * margin;
          var sx = pW / (xMax - xMin),
            sy = pH / (yMax - yMin);
          var tx = function (x) {
            return margin + (x - xMin) * sx;
          };
          var ty = function (y) {
            return H - margin - (y - yMin) * sy;
          };

          ctx.fillStyle = "#fafafa";
          ctx.fillRect(0, 0, W, H);

          ctx.strokeStyle = "#e8e8e8";
          ctx.lineWidth = 0.5;
          for (var x = Math.ceil(xMin); x <= Math.floor(xMax); x++) {
            ctx.beginPath();
            ctx.moveTo(tx(x), ty(yMin));
            ctx.lineTo(tx(x), ty(yMax));
            ctx.stroke();
          }
          for (var y = Math.ceil(yMin); y <= Math.floor(yMax); y++) {
            ctx.beginPath();
            ctx.moveTo(tx(xMin), ty(y));
            ctx.lineTo(tx(xMax), ty(y));
            ctx.stroke();
          }

          ctx.strokeStyle = "#333";
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ctx.moveTo(tx(xMin), ty(0));
          ctx.lineTo(tx(xMax), ty(0));
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(tx(0), ty(yMin));
          ctx.lineTo(tx(0), ty(yMax));
          ctx.stroke();

          ctx.fillStyle = "#555";
          ctx.font = "11px Arial";
          ctx.textAlign = "center";
          for (var x = Math.ceil(xMin); x <= Math.floor(xMax); x++) {
            if (x === 0) continue;
            ctx.fillText(x, tx(x), ty(0) + 14);
          }
          ctx.textAlign = "right";
          for (var y = Math.ceil(yMin); y <= Math.floor(yMax); y++) {
            if (y === 0) continue;
            ctx.fillText(y, tx(0) - 5, ty(y) + 4);
          }

          if (b > a) {
            ctx.beginPath();
            ctx.moveTo(tx(a), ty(0));
            for (var px = 0; px <= 200; px++) {
              var x = a + ((b - a) * px) / 200;
              ctx.lineTo(tx(x), ty(Math.abs(self.f(x)) || 0));
            }
            ctx.lineTo(tx(b), ty(0));
            ctx.closePath();
            ctx.fillStyle = "rgba(100,150,255,0.10)";
            ctx.fill();
          }

          if (b > a && n > 0) {
            var dx = (b - a) / n;
            for (var i = 0; i < n; i++) {
              var xi = a + i * dx;
              var yi = Math.abs(self.f(xi)) || 0;
              if (yi < 0.001) continue;
              var isK = i === k - 1;
              ctx.fillStyle = isK
                ? "rgba(255,200,0,0.50)"
                : "rgba(255,100,150,0.25)";
              ctx.fillRect(tx(xi), ty(yi), dx * sx, yi * sy);
              ctx.strokeStyle = isK ? "#e68a00" : "#e06688";
              ctx.lineWidth = isK ? 2 : 0.8;
              ctx.strokeRect(tx(xi), ty(yi), dx * sx, yi * sy);
            }
          }

          ctx.beginPath();
          ctx.strokeStyle = "#1565C0";
          ctx.lineWidth = 2.5;
          var started = false;
          for (var px = 0; px <= pW; px++) {
            var x = xMin + px / sx;
            var y = self.f(x);
            var ay = Math.abs(y);
            if (!isFinite(ay)) {
              started = false;
              continue;
            }
            if (!started) {
              ctx.moveTo(tx(x), ty(ay));
              started = true;
            } else ctx.lineTo(tx(x), ty(ay));
          }
          ctx.stroke();

          ctx.fillStyle = "#1565C0";
          ctx.font = "italic 13px Arial";
          ctx.textAlign = "left";
          var lx = Math.min(b * 0.8 + 0.5, xMax - 1.5);
          var ly = Math.abs(self.f(Math.max(lx, 0.1))) || 0;
          if (isFinite(ly))
            ctx.fillText("f(x) = " + self.currentFuncStr, tx(lx), ty(ly) - 8);

          ctx.setLineDash([5, 4]);
          ctx.strokeStyle = "#c62828";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(tx(a), ty(0));
          ctx.lineTo(tx(a), ty(Math.abs(self.f(a)) || 0));
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(tx(b), ty(0));
          ctx.lineTo(tx(b), ty(Math.abs(self.f(b)) || 0));
          ctx.stroke();
          ctx.setLineDash([]);

          ctx.fillStyle = "#c62828";
          ctx.font = "bold 12px Arial";
          ctx.textAlign = "center";
          ctx.fillText("a=" + a.toFixed(1), tx(a), ty(0) + 26);
          ctx.fillText("b=" + b.toFixed(1), tx(b), ty(0) + 26);
          ctx.fillStyle = "#333";
          ctx.font = "bold 13px Arial";
          ctx.textAlign = "right";
          ctx.fillText("x", tx(xMax) - 2, ty(0) - 6);
          ctx.textAlign = "left";
          ctx.fillText("y", tx(0) + 6, ty(yMax) + 14);
        },

        updateAll: function () {
          this.buildSolid();
          this.buildDisks();
          this.updateVolumes();
          this.draw2DGraph();
        },

        setupSliders: function () {
          var self = this;
          var sa = document.getElementById("slider-a");
          var sb = document.getElementById("slider-b");
          var sal = document.getElementById("slider-alpha");
          var sn = document.getElementById("slider-n");
          var sk = document.getElementById("slider-k");

          sa.addEventListener("input", function (e) {
            self.params.a = parseFloat(e.target.value);
            document.getElementById("val-a").textContent =
              self.params.a.toFixed(1);
            if (self.params.a >= self.params.b) {
              self.params.b = self.params.a + 0.1;
              sb.value = self.params.b;
              document.getElementById("val-b").textContent =
                self.params.b.toFixed(1);
            }
            sk.max = self.params.n;
            self.updateAll();
          });
          sb.addEventListener("input", function (e) {
            self.params.b = parseFloat(e.target.value);
            if (self.params.b <= self.params.a) {
              self.params.b = self.params.a + 0.1;
              e.target.value = self.params.b;
            }
            document.getElementById("val-b").textContent =
              self.params.b.toFixed(1);
            self.updateAll();
          });
          sal.addEventListener("input", function (e) {
            self.params.alpha = parseInt(e.target.value);
            document.getElementById("val-alpha").textContent =
              self.params.alpha + "\u00B0";
            self.updateAll();
          });
          sn.addEventListener("input", function (e) {
            self.params.n = parseInt(e.target.value);
            document.getElementById("val-n").textContent = self.params.n;
            sk.max = self.params.n;
            if (self.params.k > self.params.n) {
              self.params.k = self.params.n;
              sk.value = self.params.k;
              document.getElementById("val-k").textContent = self.params.k;
            }
            self.updateAll();
          });
          sk.addEventListener("input", function (e) {
            self.params.k = parseInt(e.target.value);
            document.getElementById("val-k").textContent = self.params.k;
            self.buildDisks();
            self.updateVolumes();
            self.draw2DGraph();
          });
          document
            .getElementById("func-input")
            .addEventListener("keydown", function (e) {
              if (e.key === "Enter") applyFunction();
            });
        },

        setupDrag: function (container) {
          var self = this;
          container.addEventListener("mousedown", function (e) {
            if (!e.shiftKey) return;
            self.isDragging = true;
            self.controls.enabled = false;
            var rect = self.renderer.domElement.getBoundingClientRect();
            self.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            self.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            self.raycaster.setFromCamera(self.mouse, self.camera);
            var pt = new THREE.Vector3();
            self.raycaster.ray.intersectPlane(self.dragPlane, pt);
            if (pt) self.dragOffset.copy(self.solidGroup.position).sub(pt);
          });
          container.addEventListener("mousemove", function (e) {
            if (!self.isDragging) return;
            var rect = self.renderer.domElement.getBoundingClientRect();
            self.mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            self.mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            self.raycaster.setFromCamera(self.mouse, self.camera);
            var pt = new THREE.Vector3();
            self.raycaster.ray.intersectPlane(self.dragPlane, pt);
            if (pt) {
              var newPos = pt.add(self.dragOffset);
              self.solidGroup.position.copy(newPos);
              self.diskGroup.position.copy(newPos);
              self.curveGroup.position.copy(newPos);
            }
          });
          var endDrag = function () {
            self.isDragging = false;
            self.controls.enabled = true;
          };
          container.addEventListener("mouseup", endDrag);
          container.addEventListener("mouseleave", endDrag);
        },

        onResize: function () {
          if (!this.initialized) return;
          var container = document.getElementById("container3d");
          this.camera.aspect = container.clientWidth / container.clientHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(container.clientWidth, container.clientHeight);
          this.draw2DGraph();
        },
      };

      // Global L1 button functions
      function applyFunction() {
        var expr = document.getElementById("func-input").value.trim();
        if (!expr) return;
        try {
          var fn = createSafeFunction(expr);
          L1.f = function (x) {
            var v = fn(x);
            return isFinite(v) ? Math.abs(v) : 0;
          };
          L1.currentFuncStr = expr;
          L1.updateAll();
        } catch (e) {
          alert(
            "H\u00e0m kh\u00f4ng h\u1ee3p l\u1ec7! V\u00ed d\u1ee5: sqrt(x), x^2, sin(x), x^3-2x+1",
          );
        }
      }

      function togglePlayAlpha() {
        L1.animAlpha = !L1.animAlpha;
        document
          .getElementById("btn-play-alpha")
          .classList.toggle("active", L1.animAlpha);
        document.getElementById("btn-play-alpha").textContent = L1.animAlpha
          ? "\u23F9 D\u1eebng \u03B1"
          : "\u25B6 Quay \u03B1";
        if (L1.animAlpha) {
          L1.params.alpha = 0;
          var slider = document.getElementById("slider-alpha");
          var tick = function () {
            if (!L1.animAlpha) return;
            L1.params.alpha += 2;
            if (L1.params.alpha > 360) {
              L1.params.alpha = 360;
              L1.animAlpha = false;
              document
                .getElementById("btn-play-alpha")
                .classList.remove("active");
              document.getElementById("btn-play-alpha").textContent =
                "\u25B6 Quay \u03B1";
            }
            slider.value = L1.params.alpha;
            document.getElementById("val-alpha").textContent =
              L1.params.alpha + "\u00B0";
            L1.updateAll();
            if (L1.animAlpha) requestAnimationFrame(tick);
          };
          requestAnimationFrame(tick);
        }
      }

      function togglePlayN() {
        L1.animN = !L1.animN;
        document
          .getElementById("btn-play-n")
          .classList.toggle("active", L1.animN);
        document.getElementById("btn-play-n").textContent = L1.animN
          ? "\u23F9 D\u1eebng n"
          : "\u25B6 T\u0103ng n";
        if (L1.animN) {
          L1.params.n = 1;
          var slider = document.getElementById("slider-n");
          var sk = document.getElementById("slider-k");
          var counter = 0;
          var tick = function () {
            if (!L1.animN) return;
            counter++;
            if (counter % 8 === 0) {
              L1.params.n++;
              if (L1.params.n > 100) {
                L1.params.n = 100;
                L1.animN = false;
                document
                  .getElementById("btn-play-n")
                  .classList.remove("active");
                document.getElementById("btn-play-n").textContent =
                  "\u25B6 T\u0103ng n";
              }
              slider.value = L1.params.n;
              document.getElementById("val-n").textContent = L1.params.n;
              sk.max = L1.params.n;
              if (L1.params.k > L1.params.n) {
                L1.params.k = L1.params.n;
                sk.value = L1.params.k;
              }
              L1.updateAll();
            }
            if (L1.animN) requestAnimationFrame(tick);
          };
          requestAnimationFrame(tick);
        }
      }

      function resetView() {
        L1.camera.position.set(7, 4, 6);
        L1.controls.target.set(2, 0, 0);
        L1.controls.update();
        L1.solidGroup.position.set(0, 0, 0);
        L1.diskGroup.position.set(0, 0, 0);
        L1.curveGroup.position.set(0, 0, 0);
      }

      /* =====================================================================
       LESSON 2: DEFINITE INTEGRAL + RIEMANN SUM
       ===================================================================== */
      var L2 = {
        initialized: false,
        canvas: null,
        ctx: null,
        funcStr: "x^2 - 2x + 3",
        f: null,
        params: { a: -1, b: 9, n: 50 },
        method: "left",
        animN: false,
        isDragging: false,
        lastMouse: null,
        viewXMin: -3,
        viewXMax: 12,
        viewYMin: -5,
        viewYMax: 90,

        init: function () {
          this.canvas = document.getElementById("l2-canvas");
          this.ctx = this.canvas.getContext("2d");
          try {
            this.f = createSafeFunction(this.funcStr);
          } catch (e) {
            this.f = function (x) {
              return x * x - 2 * x + 3;
            };
          }
          this.setupSliders();
          this.setupInteraction();
          this.autoFitView();
          this.draw();
          this.initialized = true;
        },

        applyFunction: function () {
          var expr = document.getElementById("l2-func-input").value.trim();
          if (!expr) return;
          try {
            var fn = createSafeFunction(expr);
            this.f = fn;
            this.funcStr = expr;
            this.autoFitView();
            this.draw();
          } catch (e) {
            alert(
              "H\u00e0m kh\u00f4ng h\u1ee3p l\u1ec7! V\u00ed d\u1ee5: x^2, sin(x), x^3-2x+1, exp(-x^2)",
            );
          }
        },

        autoFitView: function () {
          var a = this.params.a,
            b = this.params.b;
          var margin = Math.abs(b - a) * 0.2;
          this.viewXMin = Math.min(a, b) - margin - 1;
          this.viewXMax = Math.max(a, b) + margin + 1;
          var yMin = Infinity,
            yMax = -Infinity;
          for (var i = 0; i <= 300; i++) {
            var x = this.viewXMin + ((this.viewXMax - this.viewXMin) * i) / 300;
            var y = this.f(x);
            if (isFinite(y)) {
              if (y < yMin) yMin = y;
              if (y > yMax) yMax = y;
            }
          }
          if (!isFinite(yMin)) yMin = -5;
          if (!isFinite(yMax)) yMax = 5;
          var yMargin = Math.max((yMax - yMin) * 0.15, 1);
          this.viewYMin = yMin - yMargin;
          this.viewYMax = yMax + yMargin;
          if (this.viewYMin > -0.5) this.viewYMin = -0.5 - yMargin * 0.3;
        },

        setMethod: function (m) {
          this.method = m;
          var methods = ["left", "right", "mid", "trap"];
          for (var i = 0; i < methods.length; i++) {
            document.getElementById("l2-btn-" + methods[i]).style.background =
              methods[i] === m ? "#6a1b9a" : "#3a3a5a";
          }
          this.draw();
        },

        togglePlay: function () {
          var self = this;
          this.animN = !this.animN;
          document
            .getElementById("l2-btn-play")
            .classList.toggle("active", this.animN);
          document.getElementById("l2-btn-play").textContent = this.animN
            ? "\u23F9 D\u1eebng"
            : "\u25B6 T\u0103ng n";
          if (this.animN) {
            this.params.n = 1;
            var slider = document.getElementById("l2-slider-n");
            var counter = 0;
            var tick = function () {
              if (!self.animN) return;
              counter++;
              if (counter % 5 === 0) {
                self.params.n++;
                if (self.params.n > 200) {
                  self.params.n = 200;
                  self.animN = false;
                  document
                    .getElementById("l2-btn-play")
                    .classList.remove("active");
                  document.getElementById("l2-btn-play").textContent =
                    "\u25B6 T\u0103ng n";
                }
                slider.value = self.params.n;
                document.getElementById("l2-val-n").textContent = self.params.n;
                self.draw();
              }
              if (self.animN) requestAnimationFrame(tick);
            };
            requestAnimationFrame(tick);
          }
        },

        resetView: function () {
          this.autoFitView();
          this.draw();
        },

        setupSliders: function () {
          var self = this;
          document
            .getElementById("l2-slider-a")
            .addEventListener("input", function (e) {
              self.params.a = parseFloat(e.target.value);
              document.getElementById("l2-val-a").textContent =
                self.params.a.toFixed(1);
              self.autoFitView();
              self.draw();
            });
          document
            .getElementById("l2-slider-b")
            .addEventListener("input", function (e) {
              self.params.b = parseFloat(e.target.value);
              document.getElementById("l2-val-b").textContent =
                self.params.b.toFixed(1);
              self.autoFitView();
              self.draw();
            });
          document
            .getElementById("l2-slider-n")
            .addEventListener("input", function (e) {
              self.params.n = parseInt(e.target.value);
              document.getElementById("l2-val-n").textContent = self.params.n;
              self.draw();
            });
          document
            .getElementById("l2-func-input")
            .addEventListener("keydown", function (e) {
              if (e.key === "Enter") self.applyFunction();
            });
        },

        setupInteraction: function () {
          var self = this;
          var c = this.canvas;

          c.addEventListener(
            "wheel",
            function (e) {
              e.preventDefault();
              var rect = c.getBoundingClientRect();
              var mx = (e.clientX - rect.left) / rect.width;
              var my = (e.clientY - rect.top) / rect.height;
              var wx = self.viewXMin + mx * (self.viewXMax - self.viewXMin);
              var wy = self.viewYMax - my * (self.viewYMax - self.viewYMin);
              var factor = e.deltaY > 0 ? 1.1 : 0.9;
              self.viewXMin = wx - (wx - self.viewXMin) * factor;
              self.viewXMax = wx + (self.viewXMax - wx) * factor;
              self.viewYMin = wy - (wy - self.viewYMin) * factor;
              self.viewYMax = wy + (self.viewYMax - wy) * factor;
              self.draw();
            },
            { passive: false },
          );

          c.addEventListener("mousedown", function (e) {
            self.isDragging = true;
            self.lastMouse = { x: e.clientX, y: e.clientY };
          });
          c.addEventListener("mousemove", function (e) {
            if (!self.isDragging || !self.lastMouse) return;
            var rect = c.getBoundingClientRect();
            var dx =
              ((e.clientX - self.lastMouse.x) / rect.width) *
              (self.viewXMax - self.viewXMin);
            var dy =
              ((e.clientY - self.lastMouse.y) / rect.height) *
              (self.viewYMax - self.viewYMin);
            self.viewXMin -= dx;
            self.viewXMax -= dx;
            self.viewYMin += dy;
            self.viewYMax += dy;
            self.lastMouse = { x: e.clientX, y: e.clientY };
            self.draw();
          });
          c.addEventListener("mouseup", function () {
            self.isDragging = false;
            self.lastMouse = null;
          });
          c.addEventListener("mouseleave", function () {
            self.isDragging = false;
            self.lastMouse = null;
          });

          // Touch support
          var lastTouchDist = null,
            lastTouch = null;
          c.addEventListener(
            "touchstart",
            function (e) {
              if (e.touches.length === 1) {
                lastTouch = {
                  x: e.touches[0].clientX,
                  y: e.touches[0].clientY,
                };
              } else if (e.touches.length === 2) {
                lastTouchDist = Math.hypot(
                  e.touches[1].clientX - e.touches[0].clientX,
                  e.touches[1].clientY - e.touches[0].clientY,
                );
              }
            },
            { passive: true },
          );
          c.addEventListener(
            "touchmove",
            function (e) {
              e.preventDefault();
              if (e.touches.length === 1 && lastTouch) {
                var rect = c.getBoundingClientRect();
                var dx =
                  ((e.touches[0].clientX - lastTouch.x) / rect.width) *
                  (self.viewXMax - self.viewXMin);
                var dy =
                  ((e.touches[0].clientY - lastTouch.y) / rect.height) *
                  (self.viewYMax - self.viewYMin);
                self.viewXMin -= dx;
                self.viewXMax -= dx;
                self.viewYMin += dy;
                self.viewYMax += dy;
                lastTouch = {
                  x: e.touches[0].clientX,
                  y: e.touches[0].clientY,
                };
                self.draw();
              } else if (e.touches.length === 2 && lastTouchDist) {
                var dist = Math.hypot(
                  e.touches[1].clientX - e.touches[0].clientX,
                  e.touches[1].clientY - e.touches[0].clientY,
                );
                var factor = lastTouchDist / dist;
                var cx = (self.viewXMin + self.viewXMax) / 2;
                var cy = (self.viewYMin + self.viewYMax) / 2;
                var hw = ((self.viewXMax - self.viewXMin) / 2) * factor;
                var hh = ((self.viewYMax - self.viewYMin) / 2) * factor;
                self.viewXMin = cx - hw;
                self.viewXMax = cx + hw;
                self.viewYMin = cy - hh;
                self.viewYMax = cy + hh;
                lastTouchDist = dist;
                self.draw();
              }
            },
            { passive: false },
          );
          c.addEventListener("touchend", function () {
            lastTouch = null;
            lastTouchDist = null;
          });
        },

        draw: function () {
          var c = this.canvas;
          var rect = c.parentElement.getBoundingClientRect();
          var dpr = Math.min(window.devicePixelRatio || 1, 2);
          var W = Math.floor(rect.width);
          var H = Math.floor(rect.height);
          if (W <= 0 || H <= 0) return;
          c.width = W * dpr;
          c.height = H * dpr;
          c.style.width = W + "px";
          c.style.height = H + "px";
          var ctx = this.ctx;
          ctx.scale(dpr, dpr);

          var a = this.params.a,
            b = this.params.b,
            n = this.params.n;
          var self = this;
          var xMin = this.viewXMin,
            xMax = this.viewXMax;
          var yMin = this.viewYMin,
            yMax = this.viewYMax;
          var sx = W / (xMax - xMin);
          var sy = H / (yMax - yMin);
          var tx = function (x) {
            return (x - xMin) * sx;
          };
          var ty = function (y) {
            return H - (y - yMin) * sy;
          };

          // Background
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, W, H);

          // Grid
          var gridStep = function (range) {
            if (range > 100) return 20;
            if (range > 50) return 10;
            if (range > 20) return 5;
            if (range > 10) return 2;
            if (range > 4) return 1;
            if (range > 2) return 0.5;
            return 0.25;
          };
          var gx = gridStep(xMax - xMin);
          var gy = gridStep(yMax - yMin);

          ctx.strokeStyle = "#eee";
          ctx.lineWidth = 0.5;
          for (var x = Math.ceil(xMin / gx) * gx; x <= xMax; x += gx) {
            ctx.beginPath();
            ctx.moveTo(tx(x), 0);
            ctx.lineTo(tx(x), H);
            ctx.stroke();
          }
          for (var y = Math.ceil(yMin / gy) * gy; y <= yMax; y += gy) {
            ctx.beginPath();
            ctx.moveTo(0, ty(y));
            ctx.lineTo(W, ty(y));
            ctx.stroke();
          }

          // Axes
          ctx.strokeStyle = "#333";
          ctx.lineWidth = 1.5;
          if (yMin <= 0 && yMax >= 0) {
            ctx.beginPath();
            ctx.moveTo(0, ty(0));
            ctx.lineTo(W, ty(0));
            ctx.stroke();
          }
          if (xMin <= 0 && xMax >= 0) {
            ctx.beginPath();
            ctx.moveTo(tx(0), 0);
            ctx.lineTo(tx(0), H);
            ctx.stroke();
          }

          // Labels
          ctx.fillStyle = "#666";
          ctx.font = "11px Arial";
          ctx.textAlign = "center";
          for (var x = Math.ceil(xMin / gx) * gx; x <= xMax; x += gx) {
            if (Math.abs(x) < gx * 0.01) continue;
            var label = Number.isInteger(x) ? x.toString() : x.toFixed(1);
            var yPos = yMin <= 0 && yMax >= 0 ? ty(0) + 14 : H - 5;
            ctx.fillText(label, tx(x), yPos);
          }
          ctx.textAlign = "right";
          for (var y = Math.ceil(yMin / gy) * gy; y <= yMax; y += gy) {
            if (Math.abs(y) < gy * 0.01) continue;
            var label = Number.isInteger(y) ? y.toString() : y.toFixed(1);
            var xPos = xMin <= 0 && xMax >= 0 ? tx(0) - 5 : 35;
            if (xPos < 5) xPos = 35;
            ctx.fillText(label, xPos, ty(y) + 4);
          }

          // Riemann rectangles
          var aEff = Math.min(a, b),
            bEff = Math.max(a, b);
          var sign = a <= b ? 1 : -1;
          var dx = n > 0 ? (bEff - aEff) / n : 0;
          var rectAreas = [];

          if (n > 0 && bEff > aEff) {
            for (var i = 0; i < n; i++) {
              var xi = aEff + i * dx;
              var sample, y1, y2;

              if (this.method === "left") {
                sample = self.f(xi);
                if (!isFinite(sample)) sample = 0;
                ctx.fillStyle =
                  sample >= 0
                    ? "rgba(100,180,255,0.35)"
                    : "rgba(255,100,100,0.35)";
                ctx.strokeStyle =
                  sample >= 0 ? "rgba(50,100,200,0.7)" : "rgba(200,50,50,0.7)";
                ctx.lineWidth = 1;
                var rH = Math.abs(sample) * sy;
                var rY = sample >= 0 ? ty(sample) : ty(0);
                ctx.fillRect(tx(xi), rY, dx * sx, rH);
                ctx.strokeRect(tx(xi), rY, dx * sx, rH);
                rectAreas.push(sample * dx * sign);
              } else if (this.method === "right") {
                sample = self.f(xi + dx);
                if (!isFinite(sample)) sample = 0;
                ctx.fillStyle =
                  sample >= 0
                    ? "rgba(100,180,255,0.35)"
                    : "rgba(255,100,100,0.35)";
                ctx.strokeStyle =
                  sample >= 0 ? "rgba(50,100,200,0.7)" : "rgba(200,50,50,0.7)";
                ctx.lineWidth = 1;
                var rH = Math.abs(sample) * sy;
                var rY = sample >= 0 ? ty(sample) : ty(0);
                ctx.fillRect(tx(xi), rY, dx * sx, rH);
                ctx.strokeRect(tx(xi), rY, dx * sx, rH);
                rectAreas.push(sample * dx * sign);
              } else if (this.method === "mid") {
                sample = self.f(xi + dx / 2);
                if (!isFinite(sample)) sample = 0;
                ctx.fillStyle =
                  sample >= 0
                    ? "rgba(100,200,100,0.35)"
                    : "rgba(255,150,50,0.35)";
                ctx.strokeStyle =
                  sample >= 0 ? "rgba(30,150,30,0.7)" : "rgba(200,100,30,0.7)";
                ctx.lineWidth = 1;
                var rH = Math.abs(sample) * sy;
                var rY = sample >= 0 ? ty(sample) : ty(0);
                ctx.fillRect(tx(xi), rY, dx * sx, rH);
                ctx.strokeRect(tx(xi), rY, dx * sx, rH);
                rectAreas.push(sample * dx * sign);
              } else if (this.method === "trap") {
                y1 = self.f(xi);
                y2 = self.f(xi + dx);
                if (!isFinite(y1)) y1 = 0;
                if (!isFinite(y2)) y2 = 0;
                ctx.fillStyle = "rgba(200,150,255,0.35)";
                ctx.strokeStyle = "rgba(120,60,200,0.7)";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(tx(xi), ty(0));
                ctx.lineTo(tx(xi), ty(y1));
                ctx.lineTo(tx(xi + dx), ty(y2));
                ctx.lineTo(tx(xi + dx), ty(0));
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                rectAreas.push(((y1 + y2) / 2) * dx * sign);
              }
            }
          }

          // Shaded area
          ctx.beginPath();
          ctx.moveTo(tx(aEff), ty(0));
          for (var i = 0; i <= 400; i++) {
            var x = aEff + ((bEff - aEff) * i) / 400;
            var y = self.f(x);
            if (isFinite(y)) ctx.lineTo(tx(x), ty(y));
          }
          ctx.lineTo(tx(bEff), ty(0));
          ctx.closePath();
          ctx.fillStyle = "rgba(180,100,255,0.08)";
          ctx.fill();

          // Function curve
          ctx.beginPath();
          ctx.strokeStyle = "#1565C0";
          ctx.lineWidth = 2.5;
          var started = false;
          var step = (xMax - xMin) / W;
          for (var x = xMin; x <= xMax; x += step) {
            var y = self.f(x);
            if (!isFinite(y) || Math.abs(y) > 1e8) {
              started = false;
              continue;
            }
            if (!started) {
              ctx.moveTo(tx(x), ty(y));
              started = true;
            } else ctx.lineTo(tx(x), ty(y));
          }
          ctx.stroke();

          // Bound lines
          ctx.setLineDash([6, 4]);
          ctx.strokeStyle = "#c62828";
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ctx.moveTo(tx(a), 0);
          ctx.lineTo(tx(a), H);
          ctx.stroke();
          ctx.strokeStyle = "#2e7d32";
          ctx.beginPath();
          ctx.moveTo(tx(b), 0);
          ctx.lineTo(tx(b), H);
          ctx.stroke();
          ctx.setLineDash([]);

          // Labels
          ctx.fillStyle = "#c62828";
          ctx.font = "bold 13px Arial";
          ctx.textAlign = "center";
          ctx.fillText("a = " + a.toFixed(1), tx(a), 16);
          ctx.fillStyle = "#2e7d32";
          ctx.fillText("b = " + b.toFixed(1), tx(b), 16);

          ctx.fillStyle = "#1565C0";
          ctx.font = "bold italic 14px Arial";
          ctx.textAlign = "left";
          ctx.fillText("f(x) = " + self.funcStr, 10, 30);

          ctx.fillStyle = "#333";
          ctx.font = "bold 14px Arial";
          ctx.textAlign = "right";
          ctx.fillText("x", W - 5, yMin <= 0 && yMax >= 0 ? ty(0) - 5 : H - 20);
          ctx.textAlign = "left";
          ctx.fillText("y", xMin <= 0 && xMax >= 0 ? tx(0) + 5 : 5, 14);

          // Update info
          this.updateInfo(rectAreas, dx, sign);
        },

        updateInfo: function (rectAreas, dx, sign) {
          var a = this.params.a,
            b = this.params.b,
            n = this.params.n;
          var self = this;
          var aEff = Math.min(a, b),
            bEff = Math.max(a, b);
          var N = 4000,
            h = (bEff - aEff) / N,
            simpson = 0;
          for (var i = 0; i <= N; i++) {
            var x = aEff + i * h;
            var y = self.f(x);
            var yv = isFinite(y) ? y : 0;
            simpson += yv * (i === 0 || i === N ? 1 : i % 2 === 1 ? 4 : 2);
          }
          var exact = ((simpson * h) / 3) * sign;
          var approx = 0;
          for (var i = 0; i < rectAreas.length; i++) approx += rectAreas[i];

          document.getElementById("l2-exact").textContent = isFinite(exact)
            ? exact.toFixed(4)
            : "N/A";
          document.getElementById("l2-approx").textContent = isFinite(approx)
            ? approx.toFixed(4)
            : "N/A";
          document.getElementById("l2-error").textContent =
            isFinite(exact) && isFinite(approx)
              ? Math.abs(exact - approx).toFixed(4)
              : "N/A";

          var listEl = document.getElementById("l2-rect-list");
          if (rectAreas.length <= 50) {
            var vals = [];
            for (var i = 0; i < rectAreas.length; i++)
              vals.push(isFinite(rectAreas[i]) ? rectAreas[i].toFixed(2) : "?");
            listEl.textContent = "{" + vals.join(", ") + "}";
          } else {
            var first = [],
              last = [];
            for (var i = 0; i < 10; i++) first.push(rectAreas[i].toFixed(2));
            for (var i = rectAreas.length - 5; i < rectAreas.length; i++)
              last.push(rectAreas[i].toFixed(2));
            listEl.textContent =
              "{" +
              first.join(", ") +
              ", ..., " +
              last.join(", ") +
              "} (" +
              rectAreas.length +
              " values)";
          }
        },
      };

      // Window resize
      window.addEventListener("resize", function () {
        if (currentLesson === 1) L1.onResize();
        else if (currentLesson === 2 && L2.initialized) L2.draw();
      });
    </script>
  </body>
</html>
